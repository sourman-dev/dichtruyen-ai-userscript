// ==UserScript==
// @name         dichtruyen.ai.vn
// @namespace    https://github.com/sourman-dev/dichtruyen-ai-userscript
// @version      0.0.5
// @author       suppaman101@gmail.com
// @description  Userscript hỗ trợ đọc dịch online các loại truyện convert, truyện tiếng nước ngoài bằng AI
// @license      MIT
// @icon         https://vitejs.dev/logo.svg
// @supportURL   https://github.com/sourman-dev/dichtruyen-ai-userscript/issues
// @downloadURL  https://raw.githubusercontent.com/sourman-dev/dichtruyen-ai-userscript/main/dist/dichtruyen.ai.vn.user.js
// @updateURL    https://raw.githubusercontent.com/sourman-dev/dichtruyen-ai-userscript/main/dist/dichtruyen.ai.vn.user.js
// @match        *://*/*
// @grant        GM.getValue
// @grant        GM.setValue
// @inject-into  content
// ==/UserScript==

(async function () {
	'use strict';

	let t,n,r,i,a,s,o=Object.getPrototypeOf,l={isConnected:1},c={},d=o(l),u=o(o),addAndScheduleOnFirst=(t,n,r,i)=>(t??(setTimeout(r,i),new Set)).add(n),runAndCaptureDeps=(t,n,i)=>{let a=r;r=n;try{return t(i)}catch(e){return console.error(e),i}finally{r=a;}},keepConnected=t=>t.filter((t=>t._dom?.isConnected)),addStatesToGc=t=>a=addAndScheduleOnFirst(a,t,(()=>{for(let t of a)t._bindings=keepConnected(t._bindings),t._listeners=keepConnected(t._listeners);a=s;}),1e3),h={get val(){return r?._getters?.add(this),this.rawVal},get oldVal(){return r?._getters?.add(this),this._oldVal},set val(i){r?._setters?.add(this),i!==this.rawVal&&(this.rawVal=i,this._bindings.length+this._listeners.length?(n?.add(this),t=addAndScheduleOnFirst(t,this,updateDoms)):this._oldVal=i);}},state$1=t=>({__proto__:h,rawVal:t,_oldVal:t,_bindings:[],_listeners:[]}),bind=(t,n)=>{let r={_getters:new Set,_setters:new Set},a={f:t},s=i;i=[];let o=runAndCaptureDeps(t,r,n);o=(o??document).nodeType?o:new Text(o);for(let i of r._getters)r._setters.has(i)||(addStatesToGc(i),i._bindings.push(a));for(let l of i)l._dom=o;return i=s,a._dom=o},derive$1=(t,n=state$1(),r)=>{let a={_getters:new Set,_setters:new Set},s={f:t,s:n};s._dom=r??i?.push(s)??l,n.val=runAndCaptureDeps(t,a,n.rawVal);for(let i of a._getters)a._setters.has(i)||(addStatesToGc(i),i._listeners.push(s));return n},add$1=(t,...n)=>{for(let r of n.flat(1/0)){let n=o(r??0),i=n===h?bind((()=>r.val)):n===u?bind(r):r;i!=s&&t.append(i);}return t},tag=(t,n,...r)=>{let[{is:i,...a},...l]=o(r[0]??0)===d?r:[{},...r],g=t?document.createElementNS(t,n,{is:i}):document.createElement(n,{is:i});for(let[d,p]of Object.entries(a)){let getPropDescriptor=t=>t?Object.getOwnPropertyDescriptor(t,d)??getPropDescriptor(o(t)):s,t=n+","+d,r=c[t]??=getPropDescriptor(o(g))?.set??0,i=d.startsWith("on")?(t,n)=>{let r=d.slice(2);g.removeEventListener(r,n),g.addEventListener(r,t);}:r?r.bind(g):g.setAttribute.bind(g,d),a=o(p??0);d.startsWith("on")||a===u&&(p=derive$1(p),a=h),a===h?bind((()=>(i(p.val,p._oldVal),g))):i(p);}return add$1(g,l)},handler=t=>({get:(n,r)=>tag.bind(s,t,r)}),update=(t,n)=>n?n!==t&&t.replaceWith(n):t.remove(),updateDoms=()=>{let r=0,i=[...t].filter((t=>t.rawVal!==t._oldVal));do{n=new Set;for(let t of new Set(i.flatMap((t=>t._listeners=keepConnected(t._listeners)))))derive$1(t.f,t.s,t._dom),t._dom=s;}while(++r<100&&(i=[...n]).length);let a=[...t].filter((t=>t.rawVal!==t._oldVal));t=s;for(let t of new Set(a.flatMap((t=>t._bindings=keepConnected(t._bindings)))))update(t._dom,bind(t.f,t._dom)),t._dom=s;for(let t of a)t._oldVal=t.rawVal;};const g={tags:new Proxy((t=>new Proxy(tag,handler(t))),handler()),hydrate:(t,n)=>update(t,bind(n,t)),add:add$1,state:state$1,derive:derive$1};function e(t,n,r={mode:"open"}){window.customElements.define(t,class extends HTMLElement{constructor(){super(),this.a=[];}setAttribute(t,n){super.setAttribute(t,n),this.a[t]&&(this.a[t].val=n);}connectedCallback(){let t;g.add(r?this.attachShadow(r):this,n({attr:(t,n)=>this.a[t]??=g.state(this.getAttribute(t)??n),mount:n=>{let r=t;t=()=>{let t=r?.(),i=n();return ()=>{t?.(),i?.();}};},$this:this})),this.d=t?.();}disconnectedCallback(){this.d?.();}});}const{button:p,div:b,header:v,input:E,label:w,span:T,style:A}=g.tags,toStyleStr=t=>Object.entries(t).map((([t,n])=>`${t}: ${n};`)).join(""),Await=({value:t,container:n=b,Loading:r,Error:i},a)=>{const s=g.state({status:"pending"});return t.then((t=>s.val={status:"fulfilled",value:t})).catch((t=>s.val={status:"rejected",value:t})),n((()=>"pending"===s.val.status?r?.()??"":"rejected"===s.val.status?i?.(s.val.value):a(s.val.value)))};let S=0;const Tabs=({activeTab:t,resultClass:n="",style:r="",tabButtonRowColor:i="#f1f1f1",tabButtonBorderStyle:a="1px solid #000",tabButtonHoverColor:s="#ddd",tabButtonActiveColor:o="#ccc",transitionSec:l=.3,tabButtonRowClass:c="",tabButtonRowStyleOverrides:d={},tabButtonClass:u="",tabButtonStyleOverrides:h={},tabContentClass:v="",tabContentStyleOverrides:E={}},w)=>{const T=t??g.state(Object.keys(w)[0]),A=toStyleStr({overflow:"hidden","background-color":i,...d}),x=toStyleStr({float:"left",border:"none","border-right":a,outline:"none",cursor:"pointer",padding:"8px 16px",transition:`background-color ${l}s`,...h}),C=toStyleStr({padding:"6px 12px","border-top":"none",...E}),L="vanui-tabs-"+ ++S;return document.head.appendChild(g.tags.style(`#${L} .vanui-tab-button { background-color: inherit }\n#${L} .vanui-tab-button:hover { background-color: ${s} }\n#${L} .vanui-tab-button.active { background-color: ${o} }`)),b({id:L,class:n,style:r},b({class:c,style:A},Object.keys(w).map((t=>p({class:()=>["vanui-tab-button"].concat(u||[],t===T.val?"active":[]).join(" "),style:x,onclick:()=>T.val=t},t)))),Object.entries(w).map((([t,n])=>b({class:v,style:()=>`display: ${t===T.val?"block":"none"}; ${C}`},n))))};let x,C,{fromEntries:L,entries:R,keys:k,hasOwn:P,getPrototypeOf:D}=Object,{get:I,set:O,deleteProperty:B,ownKeys:M}=Reflect,{state:V,derive:$,add:G}=g,j=Symbol(),F=Symbol(),z=Symbol(),W=Symbol(),X=Symbol(),J=Symbol(),isObject=t=>t instanceof Object&&!(t instanceof Function)&&!t[J],toState=t=>{if(t?.[F]){let n=V();return $((()=>{let r=t();isObject(n.rawVal)&&isObject(r)?replace(n.rawVal,r):n.val=reactive(r);})),n}return V(reactive(t))},q={get:(t,n,r)=>n===j?t:P(t,n)?Array.isArray(t)&&"length"===n?(t[W].val,t.length):t[n].val:I(t,n,r),set:(t,n,r,i)=>P(t,n)?Array.isArray(t)&&"length"===n?(r!==t.length&&++t[W].val,t.length=r,1):(t[n].val=reactive(r),1):n in t?O(t,n,r,i):O(t,n,toState(r))&&(++t[W].val,filterBindings(t).forEach(addToContainer.bind(x,i,n,t[n],C)),1),deleteProperty:(t,n)=>(B(t,n)&&onDelete(t,n),++t[W].val),ownKeys:t=>(t[W].val,M(t))},reactive=t=>!isObject(t)||t[j]?t:new Proxy((t=>{let n=Array.isArray(t)?[]:{__proto__:D(t)};for(let[r,i]of R(t))n[r]=toState(i);return n[z]=[],n[W]=V(1),n})(t),q),filterBindings=t=>t[z]=t[z].filter((t=>t._containerDom.isConnected)),addToContainer=(t,n,r,i,{_containerDom:a,f:s})=>{let o=Array.isArray(t),l=o?Number(n):n;G(a,(()=>a[X][n]=s(r,(()=>delete t[n]),l))),o&&!i&&l!==t.length-1&&a.insertBefore(a.lastChild,a[X][k(t).find((t=>Number(t)>l))]);},onDelete=(t,n)=>{for(let r of filterBindings(t)){let t=r._containerDom[X];t[n]?.remove(),delete t[n];}},replaceInternal=(t,n)=>{for(let[a,s]of R(n)){let n=t[a];isObject(n)&&isObject(s)?replaceInternal(n,s):t[a]=s;}for(let a in t)P(n,a)||delete t[a];let r=k(n),i=Array.isArray(t);if(i||k(t).some(((t,n)=>t!==r[n]))){let a=t[j];if(i)t.length=n.length;else {++a[W].val;let t={...a};for(let n of r)delete a[n];for(let n of r)a[n]=t[n];}for(let{_containerDom:t}of filterBindings(a)){let{firstChild:n,[X]:i}=t;for(let a of r)n===i[a]?n=n.nextSibling:t.insertBefore(i[a],n);}}return t},replace=(t,n)=>{C=1;try{return replaceInternal(t,n instanceof Function?Array.isArray(t)?n(t.filter((t=>1))):L(n(R(t))):n)}finally{C=x;}},compact=t=>Array.isArray(t)?t.filter((t=>1)).map(compact):isObject(t)?L(R(t).map((([t,n])=>[t,compact(n)]))):t;var K=function(){function defineProperties(t,n){for(var r=0;r<n.length;r++){var i=n[r];i.enumerable=i.enumerable||false,i.configurable=true,"value"in i&&(i.writable=true),Object.defineProperty(t,i.key,i);}}return function(t,n,r){return n&&defineProperties(t.prototype,n),r&&defineProperties(t,r),t}}(),Y=function _taggedTemplateLiteral(t,n){return Object.freeze(Object.defineProperties(t,{raw:{value:Object.freeze(n)}}))}(["",""],["",""]);var Q=function(){function TemplateTag(){for(var t=this,n=arguments.length,r=Array(n),i=0;i<n;i++)r[i]=arguments[i];return function _classCallCheck(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,TemplateTag),this.tag=function(n){for(var r=arguments.length,i=Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];return "function"==typeof n?t.interimTag.bind(t,n):"string"==typeof n?t.transformEndResult(n):(n=n.map(t.transformString.bind(t)),t.transformEndResult(n.reduce(t.processSubstitutions.bind(t,i))))},r.length>0&&Array.isArray(r[0])&&(r=r[0]),this.transformers=r.map((function(t){return "function"==typeof t?t():t})),this.tag}return K(TemplateTag,[{key:"interimTag",value:function interimTag(t,n){for(var r=arguments.length,i=Array(r>2?r-2:0),a=2;a<r;a++)i[a-2]=arguments[a];return this.tag(Y,t.apply(void 0,[n].concat(i)))}},{key:"processSubstitutions",value:function processSubstitutions(t,n,r){var i=this.transformSubstitution(t.shift(),n);return "".concat(n,i,r)}},{key:"transformString",value:function transformString(t){return this.transformers.reduce((function cb(t,n){return n.onString?n.onString(t):t}),t)}},{key:"transformSubstitution",value:function transformSubstitution(t,n){return this.transformers.reduce((function cb(t,r){return r.onSubstitution?r.onSubstitution(t,n):t}),t)}},{key:"transformEndResult",value:function transformEndResult(t){return this.transformers.reduce((function cb(t,n){return n.onEndResult?n.onEndResult(t):t}),t)}}]),TemplateTag}(),Z=function trimResultTransformer(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return {onEndResult:function onEndResult(n){if(""===t)return n.trim();if("start"===(t=t.toLowerCase())||"left"===t)return n.replace(/^\s*/,"");if("end"===t||"right"===t)return n.replace(/\s*$/,"");throw new Error("Side not supported: "+t)}}};var ee=function stripIndentTransformer(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"initial";return {onEndResult:function onEndResult(n){if("initial"===t){var r=n.match(/^[^\S\n]*(?=\S)/gm),i=r&&Math.min.apply(Math,function _toConsumableArray(t){if(Array.isArray(t)){for(var n=0,r=Array(t.length);n<t.length;n++)r[n]=t[n];return r}return Array.from(t)}(r.map((function(t){return t.length}))));if(i){var a=new RegExp("^.{"+i+"}","gm");return n.replace(a,"")}return n}if("all"===t)return n.replace(/^[^\S\n]+/gm,"");throw new Error("Unknown type: "+t)}}},te=function replaceResultTransformer(t,n){return {onEndResult:function onEndResult(r){if(null==t||null==n)throw new Error("replaceResultTransformer requires at least 2 arguments.");return r.replace(t,n)}}},ne=function replaceSubstitutionTransformer(t,n){return {onSubstitution:function onSubstitution(r,i){if(null==t||null==n)throw new Error("replaceSubstitutionTransformer requires at least 2 arguments.");return null==r?r:r.toString().replace(t,n)}}},re={separator:"",conjunction:"",serial:false},ie=function inlineArrayTransformer(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:re;return {onSubstitution:function onSubstitution(n,r){if(Array.isArray(n)){var i=n.length,a=t.separator,s=t.conjunction,o=t.serial,l=r.match(/(\n?[^\S\n]+)$/);if(n=l?n.join(a+l[1]):n.join(a+" "),s&&i>1){var c=n.lastIndexOf(a);n=n.slice(0,c)+(o?a:"")+" "+s+n.slice(c+1);}}return n}}},ae=function splitStringTransformer(t){return {onSubstitution:function onSubstitution(n,r){return "string"==typeof n&&n.includes(t)&&(n=n.split(t)),n}}},se=function isValidValue(t){return null!=t&&!Number.isNaN(t)&&"boolean"!=typeof t};new Q(ie({separator:","}),ee,Z),new Q(ie({separator:",",conjunction:"and"}),ee,Z),new Q(ie({separator:",",conjunction:"or"}),ee,Z),new Q(ae("\n"),(function removeNonPrintingValuesTransformer(){return {onSubstitution:function onSubstitution(t){return Array.isArray(t)?t.filter(se):se(t)?t:""}}}),ie,ee,Z),new Q(ae("\n"),ie,ee,Z,ne(/&/g,"&amp;"),ne(/</g,"&lt;"),ne(/>/g,"&gt;"),ne(/"/g,"&quot;"),ne(/'/g,"&#x27;"),ne(/`/g,"&#x60;"));var oe=new Q(te(/(?:\n(?:\s*))+/g," "),Z);new Q(te(/(?:\n\s*)/g,""),Z),new Q(ie({separator:","}),te(/(?:\s+)/g," "),Z),new Q(ie({separator:",",conjunction:"or"}),te(/(?:\s+)/g," "),Z),new Q(ie({separator:",",conjunction:"and"}),te(/(?:\s+)/g," "),Z),new Q(ie,ee,Z),new Q(ie,te(/(?:\s+)/g," "),Z);var le=new Q(ee,Z);function promisifyRequest(t){return new Promise(((n,r)=>{t.oncomplete=t.onsuccess=()=>n(t.result),t.onabort=t.onerror=()=>r(t.error);}))}let ce;function defaultGetStore(){return ce||(ce=function createStore(t,n){const r=indexedDB.open(t);r.onupgradeneeded=()=>r.result.createObjectStore(n);const i=promisifyRequest(r);return (t,r)=>i.then((i=>r(i.transaction(n,t).objectStore(n))))}("keyval-store","keyval")),ce}new Q(ee("all"),Z);const db_get=async t=>await function get(t,n=defaultGetStore()){return n("readonly",(n=>promisifyRequest(n.get(t))))}(t),db_set=async(t,n)=>await function set(t,n,r=defaultGetStore()){return r("readwrite",(r=>(r.put(n,t),promisifyRequest(r.transaction))))}(t,n),db_del=async t=>await function del(t,n=defaultGetStore()){return n("readwrite",(n=>(n.delete(t),promisifyRequest(n.transaction))))}(t);var de=(()=>"undefined"!=typeof GM?GM:void 0)();async function fetchApi(t,n="json"){try{const r=await fetch(t);return "json"===n?await r.json():await r.text()}catch(r){throw new Error(`Fetch error: ${r}`)}}async function fetchAndCached(t,n=false){const{apiURL:r,apiType:i,nameOfCache:a}=t,s=await de.getValue(`${a}-check`),o=await de.getValue(a);if(n||!s||!o||Date.now()-s>432e5)try{let n=await fetchApi(r,i);return t.parseJSON&&(n=n?JSON.parse(n):null),n&&(await de.setValue(a,t.parseJSON?JSON.stringify(n):n),await de.setValue(`${a}-check`,Date.now())),n}catch(l){return console.error("Error fetching:",l),o?JSON.parse(o):null}return t.parseJSON?JSON.parse(o):o}async function getSystemPrompt(t=false){return await fetchAndCached({apiURL:"https://gist.githubusercontent.com/sourman-dev/1f8bc4876a5a300105ec657231fbfb30/raw",apiType:"text",nameOfCache:"dichtruyen:ai-systemPrompt"},t)}async function getAiProviders(t=false){return await fetchAndCached({apiURL:"https://gist.githubusercontent.com/sourman-dev/7d393f0f46987eec725da4388e278813/raw",apiType:"text",nameOfCache:"dichtruyen-ai:providers",parseJSON:true},t)}const translateFunc=async(t,n)=>{try{const r=function currentAiProvider(){const t={name:null,baseURL:null,model:null,apiKey:null},n=ge.providers.find((t=>!0===t.selected));if(n){t.name=n.name,t.baseURL=n.baseUrl,t.apiKey=n.apiKey;const r=n.models.find((t=>!0===t.selected));r&&(t.model=r.name);}if(null!==t.apiKey&&null!==t.model)return t}();if(!t||t.length<=5)return;const i=function currentPrompt(t){const n=ge.prompt.systemPrompts.find((t=>t.selected))?.content,r=ge.prompt.userPrompts.find((t=>t.selected))?.content;return {isValid:null!=n&&n.length>10,content:le`${oe`${n}\n${r}`}\n<content>${t}</content>`}}(t);if(!r||!i.isValid)return;if(replaceAppState({isTranslating:!0,currentView:"reader"}),!r?.baseURL||!r?.apiKey)throw new Error("AI provider configuration is incomplete.");let a="";const s={baseURL:r.baseURL,apiKey:r.apiKey,data:{model:r?.model,messages:[{role:"user",content:i.content}],stream:!0}};await async function openAICompletion(t,n){try{const r=`${t.baseURL}chat/completions`,i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify(t.data)});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);if(i.body?.getReader){const t=i.body.getReader(),r=new TextDecoder;let a="";for(;;){const{done:i,value:s}=await t.read();if(i)break;a+=r.decode(s,{stream:!0});const o=a.split("\n");a=o.pop()||"";for(const t of o){const r=t.trim();if(r&&r.startsWith("data: "))try{const t=r.slice(5).trim();if("[DONE]"===t)return void n("\n[Translation completed]");const i=JSON.parse(t),a=i?.choices?.[0]?.delta?.content;if(a&&n(a),"stop"===i?.choices?.[0]?.finish_reason)return void n("\n[Translation completed]")}catch(e){console.warn("Error parsing chunk:",e);continue}}}}else {const t=await i.text();try{const r=t.split("\n");for(const t of r)if(t.startsWith("data: ")){const r=t.slice(5).trim();if("[DONE]"===r)continue;const i=JSON.parse(r),a=i?.choices?.[0]?.delta?.content;a&&n(a);}n("\n[Translation completed]");}catch(e){throw console.error("Error processing response:",e),e}}}catch(r){throw console.error("Stream error:",r),r}}(s,(t=>{console.log("In progress..."),a+=t,n(a);})),console.log("Done!");const o={url:window.location.href,title:document.title,cachedAt:Date.now(),...findPrevNextChapterLinks()};replaceAppState({isTranslating:!1,currentView:"reader"}),await(async(t,n)=>{try{if(!t?.url)return;let r=JSON.parse(localStorage.getItem("dichtruyen-ai:history")||"[]");r=r.filter((t=>t&&t.url));const i=r.findIndex((n=>n.url===t.url));-1!==i?r[i]=t:(r.length>=20&&r.shift(),r.push(t)),localStorage.setItem("dichtruyen-ai:history",JSON.stringify(r)),await db_set(`history:${t.url}`,t),await db_set(`translated:${t.url}`,n);}catch(r){console.error("Failed to save to history:",r);}})(o,a);}catch(r){console.error(r);}finally{replaceAppState({isTranslating:false});}};function findPrevNextChapterLinks(){const t=window.location.href,n=window.location.origin,r=t.split("/").pop()||"",i=t.replace(n,"").replace(r,""),a=document.getElementsByTagName("a"),s=[...new Set(Array.from(a).map((t=>t.href)).filter((t=>t&&-1!==t.lastIndexOf(`${n}${i}`))).filter((t=>{const r=t.split("/").pop();return t!==`${n}${i}`&&null!=r?.match(/\d+/)})).concat(t))].sort(((t,n)=>{const r=t.split("/").pop(),i=n.split("/").pop();return parseInt(r?.match(/\d+/)?.[0]??"0",10)-parseInt(i?.match(/\d+/)?.[0]??"0",10)}));if(2===s.length){if(s[0]===t)return {previous:null,next:s[1]};if(s[1]===t)return {previous:s[0],next:null}}else if(3===s.length&&s[1]===t)return {previous:s[0],next:s[2]};return {previous:null,next:null}}const fetchResource=async t=>await fetchApi(t,"text"),getRelease=async(t=false)=>{try{const n={apiURL:"https://api.github.com/repos/sourman-dev/dichtruyen-ai-userscript/releases/latest",apiType:"text",nameOfCache:"dichtruyen-ai:release",parseJSON:!0},r=await fetchAndCached(n,t),i={version:r.tag_name,description:r.body,fileUrl:r.assets[0]?.browser_download_url||null};return await de.setValue("dichtruyen-ai:release",JSON.stringify(i)),i}catch(e){return {version:"0.0.5",description:null,fileUrl:null}}},ue={version:"0.0.5",prompt:{systemPrompts:[],userPrompts:[{id:"default-0",name:"Default",content:"",selected:true}]},providers:[],readerView:{backgroundColor:"#F4F4F4",fontFamily:"system-ui",lineHeight:"1.2",fontSize:18,bionicReading:false,includeTitle:false}};let he;const ge=reactive(ue),pe=reactive({currentView:"empty",isTranslating:false,openReaderConfig:false}),mergeProviders=async t=>{const n=await getAiProviders(true);return n?.providers&&(t.providers=n.providers.map((n=>{const r=t.providers.find((t=>t.name===n.name));return r&&(r.apiKey||r.selected)?{...n,apiKey:r.apiKey,selected:r.selected}:n}))),t},mergeSystemPrompt=async t=>{const n=await getSystemPrompt(true),r=t.prompt.systemPrompts.find((t=>"default-0"===t.id));return r?r.content=n:t.prompt.systemPrompts.push({id:"default-0",name:"Default",content:n,selected:true}),t},replaceAppState=t=>{replace(pe,Object.assign(pe,t));},replaceReaderState=t=>{replace(ge.readerView,Object.assign({},ge.readerView,t));};const{span:me,button:fe,div:be}=g.tags,createIconButton=(t,n,r)=>fe({class:"icon-button",id:r||void 0,onclick:n},t);function changeView(t){const n=pe.currentView===t?"empty":t;replaceAppState({currentView:n});}const iconEl=t=>me({class:"icon",style:`background-image: url('data:image/svg+xml;utf8,${t}');`}),ye=iconEl('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>'),ve=iconEl('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>'),_e=iconEl('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>'),Ne=iconEl('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M6 6h12v12H6z"/></svg>'),changeIcon=t=>{Array.from(document.querySelectorAll("*")).map((t=>t.shadowRoot)).filter((t=>null!==t)).forEach((n=>{const r=n.querySelector("#transButton");if(r){for(;r.firstChild;)r.removeChild(r.firstChild);r.appendChild(t);}}));},{p:Ee,div:we,button:Te,select:Ae,option:Se,label:xe,input:Ce}=g.tags,Le=[{name:"System ui",value:"system-ui"},{name:"Times New Roman",value:"Times New Roman"},{name:"Arial",value:"Arial"},{name:"Verdana",value:"Verdana"},{name:"Tahoma",value:"Tahoma"},{name:"Segoe UI",value:"Segoe UI"}],Re=[{name:"Light Gray",value:"#F4F4F4"},{name:"Light Blue",value:"#E8EBEE"},{name:"Deep Blue",value:"#E1E4F2"},{name:"Light Yellow",value:"#F4F4E3"},{name:"Sepia",value:"#EAE4D3"},{name:"Deep Yellow",value:"#FAFAC8"},{name:"Dark",value:"black"}],ke=["1.6","1","1.2","1.4","1.8","2"],openCloseModal=(t="none")=>{Array.from(document.querySelectorAll("*")).map((t=>t.shadowRoot)).filter((t=>null!==t)).forEach((n=>{const r=n.getElementById("mdlReaderContainer");r&&(r.style.display=t);}));},Pe=g.derive((()=>ge.readerView));function ModalReaderConfig(){const t=g.state(false);return we({id:"mdlReaderContainer",style:"display: none"},(({closed:t,backgroundColor:n="rgba(0,0,0,.5)",blurBackground:r=false,clickBackgroundToClose:i=false,backgroundClass:a="",backgroundStyleOverrides:s={},modalClass:o="",modalStyleOverrides:l={}},...c)=>{const d={display:"flex","align-items":"center","justify-content":"center",left:0,right:0,top:0,bottom:0,position:"fixed","z-index":1e4,"background-color":n,"backdrop-filter":r?"blur(0.25rem)":"none",...s},u={"border-radius":"0.5rem",padding:"1rem",display:"block","background-color":"white",...l};return document.activeElement instanceof HTMLElement&&document.activeElement.blur(),()=>{if(t.val)return null;const n=b({class:a,style:toStyleStr(d)},b({class:o,style:toStyleStr(u)},c));return i&&n.addEventListener("click",(r=>r.target===n&&(t.val=true))),n}})({closed:t},we({class:"pure-g"},we({class:"pure-u-1 pure-u-md-1-2 p-1"},Ee("Font Family"),Ae({class:"pure-input-1",onchange:t=>{replaceReaderState({fontFamily:t.target.value});}},Le.map((t=>Se({value:t.value,selected:()=>Pe.val.fontFamily===t.value},t.name))))),we({class:"pure-u-1 pure-u-md-1-2 p-1"},Ee("Font Size"),Ae({class:"pure-input-1",onchange:t=>{replaceReaderState({fontSize:t.target.value});}},Array.from({length:15},((t,n)=>n+16)).map((t=>Se({value:t,selected:()=>Number(Pe.val.fontSize)===t},`${t}px`))))),we({class:"pure-u-1 pure-u-md-1-2 p-1"},Ee("Background Color"),Ae({class:"pure-input-1",onchange:t=>{replaceReaderState({backgroundColor:t.target.value});}},Re.map((t=>Se({value:t.value,selected:()=>Pe.val.backgroundColor===t.value},t.name))))),we({class:"pure-u-1 pure-u-md-1-2 p-1"},Ee("Line Height"),Ae({class:"pure-input-1",onchange:t=>{replaceReaderState({lineHeight:t.target.value});}},ke.map((t=>Se({value:t,selected:()=>Pe.val.lineHeight===t},t))))),we({class:"pure-u-1 p-1",style:"margin: 5px 0px;"},xe({class:"pure-checkbox"},Ce({type:"checkbox",checked:Pe.val.bionicReading,onchange:t=>{replaceReaderState({bionicReading:t.target.checked});}})," Fast Reader"))),we({style:"display: flex; justify-content: center;"},Te({onclick:()=>replaceAppState({openReaderConfig:false})},"Ok"))))}g.derive((()=>{ true===pe.openReaderConfig?openCloseModal("flex"):openCloseModal("none");}));const{div:De,style:Ie,button:Oe,a:Be}=g.tags,currentHistory=async()=>await db_get(`history:${window.location.href}`),createHistoryItem=(t,n)=>De({class:"history-item"},Be({href:t,class:"history-link",onclick:n=>{n.preventDefault(),window.location.href=t;}},n),Oe({onclick:async function(){await(async t=>{try{await db_del(`history:${t}`),await db_del(`translated:${t}`);let n=JSON.parse(localStorage.getItem("dichtruyen-ai:history")||"[]");return n=n.filter((n=>n.url!==t)),localStorage.setItem("dichtruyen-ai:history",JSON.stringify(n)),!0}catch(n){throw console.error("Failed to delete history item:",n),n}})(t),window.location.reload();},class:"delete-button"},"❌"));e("history-view",(({})=>{let t=JSON.parse(localStorage.getItem("dichtruyen-ai:history")||"[]");return t=t.filter((t=>t.url!==window.location.href)),[Ie("\n        .history-item {\n          padding: 0.5em;\n          margin: 0.5em 0;\n          border-bottom: 1px solid #eee;\n        }\n        .history-link {\n          text-decoration: none;\n          color: #333;\n          margin-right: 1em;\n        }\n        .delete-button {\n          float: right;\n          border: none;\n          background: none;\n          cursor: pointer;\n        }\n        .empty-label {\n          text-align: center;\n          padding: 2em;\n          color: #666;\n        }\n        .history-list {\n          max-height: 700px;\n          overflow-y: auto;\n          border-bottom: 3px solid #333;\n        }\n      "),De({class:"pure-g"},De({class:"pure-u-1 history-list"},0===t.length?De({class:"empty-label"},"Lịch sử trống"):t.map((t=>createHistoryItem(t.url,t.title)))),Await({value:currentHistory(),container:De},(t=>t&&createHistoryItem(t.url,t.title))))]}),false);var Me,Ve={exports:{}};function requireReadability$1(){return Me||(Me=1,function(t){function Readability(t,n){if(n&&n.documentElement)t=n,n=arguments[2];else if(!t||!t.documentElement)throw new Error("First argument to Readability constructor should be a document object.");if(n=n||{},this._doc=t,this._docJSDOMParser=this._doc.firstChild.__JSDOMParser__,this._articleTitle=null,this._articleByline=null,this._articleDir=null,this._articleSiteName=null,this._attempts=[],this._metadata={},this._debug=!!n.debug,this._maxElemsToParse=n.maxElemsToParse||this.DEFAULT_MAX_ELEMS_TO_PARSE,this._nbTopCandidates=n.nbTopCandidates||this.DEFAULT_N_TOP_CANDIDATES,this._charThreshold=n.charThreshold||this.DEFAULT_CHAR_THRESHOLD,this._classesToPreserve=this.CLASSES_TO_PRESERVE.concat(n.classesToPreserve||[]),this._keepClasses=!!n.keepClasses,this._serializer=n.serializer||function(t){return t.innerHTML},this._disableJSONLD=!!n.disableJSONLD,this._allowedVideoRegex=n.allowedVideoRegex||this.REGEXPS.videos,this._linkDensityModifier=n.linkDensityModifier||0,this._flags=this.FLAG_STRIP_UNLIKELYS|this.FLAG_WEIGHT_CLASSES|this.FLAG_CLEAN_CONDITIONALLY,this._debug){let logNode=function(t){if(t.nodeType==t.TEXT_NODE)return `${t.nodeName} ("${t.textContent}")`;let n=Array.from(t.attributes||[],(function(t){return `${t.name}="${t.value}"`})).join(" ");return `<${t.localName} ${n}>`};this.log=function(){if("undefined"!=typeof console){let t=Array.from(arguments,(t=>t&&t.nodeType==this.ELEMENT_NODE?logNode(t):t));t.unshift("Reader: (Readability)"),console.log(...t);}else if("undefined"!=typeof dump){var t=Array.prototype.map.call(arguments,(function(t){return t&&t.nodeName?logNode(t):t})).join(" ");dump("Reader: (Readability) "+t+"\n");}};}else this.log=function(){};}Readability.prototype={FLAG_STRIP_UNLIKELYS:1,FLAG_WEIGHT_CLASSES:2,FLAG_CLEAN_CONDITIONALLY:4,ELEMENT_NODE:1,TEXT_NODE:3,DEFAULT_MAX_ELEMS_TO_PARSE:0,DEFAULT_N_TOP_CANDIDATES:5,DEFAULT_TAGS_TO_SCORE:"section,h2,h3,h4,h5,h6,p,td,pre".toUpperCase().split(","),DEFAULT_CHAR_THRESHOLD:500,REGEXPS:{unlikelyCandidates:/-ad-|ai2html|banner|breadcrumbs|combx|comment|community|cover-wrap|disqus|extra|footer|gdpr|header|legends|menu|related|remark|replies|rss|shoutbox|sidebar|skyscraper|social|sponsor|supplemental|ad-break|agegate|pagination|pager|popup|yom-remote/i,okMaybeItsACandidate:/and|article|body|column|content|main|shadow/i,positive:/article|body|content|entry|hentry|h-entry|main|page|pagination|post|text|blog|story/i,negative:/-ad-|hidden|^hid$| hid$| hid |^hid |banner|combx|comment|com-|contact|footer|gdpr|masthead|media|meta|outbrain|promo|related|scroll|share|shoutbox|sidebar|skyscraper|sponsor|shopping|tags|widget/i,extraneous:/print|archive|comment|discuss|e[\-]?mail|share|reply|all|login|sign|single|utility/i,byline:/byline|author|dateline|writtenby|p-author/i,replaceFonts:/<(\/?)font[^>]*>/gi,normalize:/\s{2,}/g,videos:/\/\/(www\.)?((dailymotion|youtube|youtube-nocookie|player\.vimeo|v\.qq)\.com|(archive|upload\.wikimedia)\.org|player\.twitch\.tv)/i,shareElements:/(\b|_)(share|sharedaddy)(\b|_)/i,nextLink:/(next|weiter|continue|>([^\|]|$)|»([^\|]|$))/i,prevLink:/(prev|earl|old|new|<|«)/i,tokenize:/\W+/g,whitespace:/^\s*$/,hasContent:/\S$/,hashUrl:/^#.+/,srcsetUrl:/(\S+)(\s+[\d.]+[xw])?(\s*(?:,|$))/g,b64DataUrl:/^data:\s*([^\s;,]+)\s*;\s*base64\s*,/i,commas:/\u002C|\u060C|\uFE50|\uFE10|\uFE11|\u2E41|\u2E34|\u2E32|\uFF0C/g,jsonLdArticleTypes:/^Article|AdvertiserContentArticle|NewsArticle|AnalysisNewsArticle|AskPublicNewsArticle|BackgroundNewsArticle|OpinionNewsArticle|ReportageNewsArticle|ReviewNewsArticle|Report|SatiricalArticle|ScholarlyArticle|MedicalScholarlyArticle|SocialMediaPosting|BlogPosting|LiveBlogPosting|DiscussionForumPosting|TechArticle|APIReference$/,adWords:/^(ad(vertising|vertisement)?|pub(licité)?|werb(ung)?|广告|Реклама|Anuncio)$/iu,loadingWords:/^((loading|正在加载|Загрузка|chargement|cargando)(…|\.\.\.)?)$/iu},UNLIKELY_ROLES:["menu","menubar","complementary","navigation","alert","alertdialog","dialog"],DIV_TO_P_ELEMS:new Set(["BLOCKQUOTE","DL","DIV","IMG","OL","P","PRE","TABLE","UL"]),ALTER_TO_DIV_EXCEPTIONS:["DIV","ARTICLE","SECTION","P","OL","UL"],PRESENTATIONAL_ATTRIBUTES:["align","background","bgcolor","border","cellpadding","cellspacing","frame","hspace","rules","style","valign","vspace"],DEPRECATED_SIZE_ATTRIBUTE_ELEMS:["TABLE","TH","TD","HR","PRE"],PHRASING_ELEMS:["ABBR","AUDIO","B","BDO","BR","BUTTON","CITE","CODE","DATA","DATALIST","DFN","EM","EMBED","I","IMG","INPUT","KBD","LABEL","MARK","MATH","METER","NOSCRIPT","OBJECT","OUTPUT","PROGRESS","Q","RUBY","SAMP","SCRIPT","SELECT","SMALL","SPAN","STRONG","SUB","SUP","TEXTAREA","TIME","VAR","WBR"],CLASSES_TO_PRESERVE:["page"],HTML_ESCAPE_MAP:{lt:"<",gt:">",amp:"&",quot:'"',apos:"'"},_postProcessContent(t){this._fixRelativeUris(t),this._simplifyNestedElements(t),this._keepClasses||this._cleanClasses(t);},_removeNodes(t,n){if(this._docJSDOMParser&&t._isLiveNodeList)throw new Error("Do not pass live node lists to _removeNodes");for(var r=t.length-1;r>=0;r--){var i=t[r],a=i.parentNode;a&&(n&&!n.call(this,i,r,t)||a.removeChild(i));}},_replaceNodeTags(t,n){if(this._docJSDOMParser&&t._isLiveNodeList)throw new Error("Do not pass live node lists to _replaceNodeTags");for(const r of t)this._setNodeTag(r,n);},_forEachNode(t,n){Array.prototype.forEach.call(t,n,this);},_findNode(t,n){return Array.prototype.find.call(t,n,this)},_someNode(t,n){return Array.prototype.some.call(t,n,this)},_everyNode(t,n){return Array.prototype.every.call(t,n,this)},_getAllNodesWithTag:(t,n)=>t.querySelectorAll?t.querySelectorAll(n.join(",")):[].concat.apply([],n.map((function(n){var r=t.getElementsByTagName(n);return Array.isArray(r)?r:Array.from(r)}))),_cleanClasses(t){var n=this._classesToPreserve,r=(t.getAttribute("class")||"").split(/\s+/).filter((t=>n.includes(t))).join(" ");for(r?t.setAttribute("class",r):t.removeAttribute("class"),t=t.firstElementChild;t;t=t.nextElementSibling)this._cleanClasses(t);},_isUrl(t){try{return new URL(t),!0}catch{return  false}},_fixRelativeUris(t){var n=this._doc.baseURI,r=this._doc.documentURI;function toAbsoluteURI(t){if(n==r&&"#"==t.charAt(0))return t;try{return new URL(t,n).href}catch(i){}return t}var i=this._getAllNodesWithTag(t,["a"]);this._forEachNode(i,(function(t){var n=t.getAttribute("href");if(n)if(0===n.indexOf("javascript:"))if(1===t.childNodes.length&&t.childNodes[0].nodeType===this.TEXT_NODE){var r=this._doc.createTextNode(t.textContent);t.parentNode.replaceChild(r,t);}else {for(var i=this._doc.createElement("span");t.firstChild;)i.appendChild(t.firstChild);t.parentNode.replaceChild(i,t);}else t.setAttribute("href",toAbsoluteURI(n));}));var a=this._getAllNodesWithTag(t,["img","picture","figure","video","audio","source"]);this._forEachNode(a,(function(t){var n=t.getAttribute("src"),r=t.getAttribute("poster"),i=t.getAttribute("srcset");if(n&&t.setAttribute("src",toAbsoluteURI(n)),r&&t.setAttribute("poster",toAbsoluteURI(r)),i){var a=i.replace(this.REGEXPS.srcsetUrl,(function(t,n,r,i){return toAbsoluteURI(n)+(r||"")+i}));t.setAttribute("srcset",a);}}));},_simplifyNestedElements(t){for(var n=t;n;){if(n.parentNode&&["DIV","SECTION"].includes(n.tagName)&&(!n.id||!n.id.startsWith("readability"))){if(this._isElementWithoutContent(n)){n=this._removeAndGetNext(n);continue}if(this._hasSingleTagInsideElement(n,"DIV")||this._hasSingleTagInsideElement(n,"SECTION")){for(var r=n.children[0],i=0;i<n.attributes.length;i++)r.setAttributeNode(n.attributes[i].cloneNode());n.parentNode.replaceChild(r,n),n=r;continue}}n=this._getNextNode(n);}},_getArticleTitle(){var t=this._doc,n="",r="";try{"string"!=typeof(n=r=t.title.trim())&&(n=r=this._getInnerText(t.getElementsByTagName("title")[0]));}catch(e){}var i=false;function wordCount(t){return t.split(/\s+/).length}if(/ [\|\-\\\/>»] /.test(n)){i=/ [\\\/>»] /.test(n);let t=Array.from(r.matchAll(/ [\|\-\\\/>»] /gi));wordCount(n=r.substring(0,t.pop().index))<3&&(n=r.replace(/^[^\|\-\\\/>»]*[\|\-\\\/>»]/gi,""));}else if(n.includes(": ")){var a=this._getAllNodesWithTag(t,["h1","h2"]),s=n.trim();this._someNode(a,(function(t){return t.textContent.trim()===s}))||(wordCount(n=r.substring(r.lastIndexOf(":")+1))<3?n=r.substring(r.indexOf(":")+1):wordCount(r.substr(0,r.indexOf(":")))>5&&(n=r));}else if(n.length>150||n.length<15){var o=t.getElementsByTagName("h1");1===o.length&&(n=this._getInnerText(o[0]));}var l=wordCount(n=n.trim().replace(this.REGEXPS.normalize," "));return l<=4&&(!i||l!=wordCount(r.replace(/[\|\-\\\/>»]+/g,""))-1)&&(n=r),n},_prepDocument(){var t=this._doc;this._removeNodes(this._getAllNodesWithTag(t,["style"])),t.body&&this._replaceBrs(t.body),this._replaceNodeTags(this._getAllNodesWithTag(t,["font"]),"SPAN");},_nextNode(t){for(var n=t;n&&n.nodeType!=this.ELEMENT_NODE&&this.REGEXPS.whitespace.test(n.textContent);)n=n.nextSibling;return n},_replaceBrs(t){this._forEachNode(this._getAllNodesWithTag(t,["br"]),(function(t){for(var n=t.nextSibling,r=false;(n=this._nextNode(n))&&"BR"==n.tagName;){r=true;var i=n.nextSibling;n.remove(),n=i;}if(r){var a=this._doc.createElement("p");for(t.parentNode.replaceChild(a,t),n=a.nextSibling;n;){if("BR"==n.tagName){var s=this._nextNode(n.nextSibling);if(s&&"BR"==s.tagName)break}if(!this._isPhrasingContent(n))break;var o=n.nextSibling;a.appendChild(n),n=o;}for(;a.lastChild&&this._isWhitespace(a.lastChild);)a.lastChild.remove();"P"===a.parentNode.tagName&&this._setNodeTag(a.parentNode,"DIV");}}));},_setNodeTag(t,n){if(this.log("_setNodeTag",t,n),this._docJSDOMParser)return t.localName=n.toLowerCase(),t.tagName=n.toUpperCase(),t;for(var r=t.ownerDocument.createElement(n);t.firstChild;)r.appendChild(t.firstChild);t.parentNode.replaceChild(r,t),t.readability&&(r.readability=t.readability);for(var i=0;i<t.attributes.length;i++)r.setAttributeNode(t.attributes[i].cloneNode());return r},_prepArticle(t){this._cleanStyles(t),this._markDataTables(t),this._fixLazyImages(t),this._cleanConditionally(t,"form"),this._cleanConditionally(t,"fieldset"),this._clean(t,"object"),this._clean(t,"embed"),this._clean(t,"footer"),this._clean(t,"link"),this._clean(t,"aside");var n=this.DEFAULT_CHAR_THRESHOLD;this._forEachNode(t.children,(function(t){this._cleanMatchedNodes(t,(function(t,r){return this.REGEXPS.shareElements.test(r)&&t.textContent.length<n}));})),this._clean(t,"iframe"),this._clean(t,"input"),this._clean(t,"textarea"),this._clean(t,"select"),this._clean(t,"button"),this._cleanHeaders(t),this._cleanConditionally(t,"table"),this._cleanConditionally(t,"ul"),this._cleanConditionally(t,"div"),this._replaceNodeTags(this._getAllNodesWithTag(t,["h1"]),"h2"),this._removeNodes(this._getAllNodesWithTag(t,["p"]),(function(t){return 0===this._getAllNodesWithTag(t,["img","embed","object","iframe"]).length&&!this._getInnerText(t,false)})),this._forEachNode(this._getAllNodesWithTag(t,["br"]),(function(t){var n=this._nextNode(t.nextSibling);n&&"P"==n.tagName&&t.remove();})),this._forEachNode(this._getAllNodesWithTag(t,["table"]),(function(t){var n=this._hasSingleTagInsideElement(t,"TBODY")?t.firstElementChild:t;if(this._hasSingleTagInsideElement(n,"TR")){var r=n.firstElementChild;if(this._hasSingleTagInsideElement(r,"TD")){var i=r.firstElementChild;i=this._setNodeTag(i,this._everyNode(i.childNodes,this._isPhrasingContent)?"P":"DIV"),t.parentNode.replaceChild(i,t);}}}));},_initializeNode(t){switch(t.readability={contentScore:0},t.tagName){case "DIV":t.readability.contentScore+=5;break;case "PRE":case "TD":case "BLOCKQUOTE":t.readability.contentScore+=3;break;case "ADDRESS":case "OL":case "UL":case "DL":case "DD":case "DT":case "LI":case "FORM":t.readability.contentScore-=3;break;case "H1":case "H2":case "H3":case "H4":case "H5":case "H6":case "TH":t.readability.contentScore-=5;}t.readability.contentScore+=this._getClassWeight(t);},_removeAndGetNext(t){var n=this._getNextNode(t,true);return t.remove(),n},_getNextNode(t,n){if(!n&&t.firstElementChild)return t.firstElementChild;if(t.nextElementSibling)return t.nextElementSibling;do{t=t.parentNode;}while(t&&!t.nextElementSibling);return t&&t.nextElementSibling},_textSimilarity(t,n){var r=t.toLowerCase().split(this.REGEXPS.tokenize).filter(Boolean),i=n.toLowerCase().split(this.REGEXPS.tokenize).filter(Boolean);return r.length&&i.length?1-i.filter((t=>!r.includes(t))).join(" ").length/i.join(" ").length:0},_isValidByline(t,n){var r=t.getAttribute("rel"),i=t.getAttribute("itemprop"),a=t.textContent.trim().length;return ("author"===r||i&&i.includes("author")||this.REGEXPS.byline.test(n))&&!!a&&a<100},_getNodeAncestors(t,n){n=n||0;for(var r=0,i=[];t.parentNode&&(i.push(t.parentNode),!n||++r!==n);)t=t.parentNode;return i},_grabArticle(t){this.log("**** grabArticle ****");var n=this._doc,r=null!==t;if(!(t=t||this._doc.body))return this.log("No body found in document. Abort."),null;for(var i=t.innerHTML;;){this.log("Starting grabArticle loop");var a=this._flagIsActive(this.FLAG_STRIP_UNLIKELYS),s=[],o=this._doc.documentElement;let re=true;for(;o;){"HTML"===o.tagName&&(this._articleLang=o.getAttribute("lang"));var l=o.className+" "+o.id;if(this._isProbablyVisible(o))if("true"!=o.getAttribute("aria-modal")||"dialog"!=o.getAttribute("role"))if(this._articleByline||this._metadata.byline||!this._isValidByline(o,l))if(re&&this._headerDuplicatesTitle(o))this.log("Removing header: ",o.textContent.trim(),this._articleTitle.trim()),re=false,o=this._removeAndGetNext(o);else {if(a){if(this.REGEXPS.unlikelyCandidates.test(l)&&!this.REGEXPS.okMaybeItsACandidate.test(l)&&!this._hasAncestorTag(o,"table")&&!this._hasAncestorTag(o,"code")&&"BODY"!==o.tagName&&"A"!==o.tagName){this.log("Removing unlikely candidate - "+l),o=this._removeAndGetNext(o);continue}if(this.UNLIKELY_ROLES.includes(o.getAttribute("role"))){this.log("Removing content with role "+o.getAttribute("role")+" - "+l),o=this._removeAndGetNext(o);continue}}if("DIV"!==o.tagName&&"SECTION"!==o.tagName&&"HEADER"!==o.tagName&&"H1"!==o.tagName&&"H2"!==o.tagName&&"H3"!==o.tagName&&"H4"!==o.tagName&&"H5"!==o.tagName&&"H6"!==o.tagName||!this._isElementWithoutContent(o)){if(this.DEFAULT_TAGS_TO_SCORE.includes(o.tagName)&&s.push(o),"DIV"===o.tagName){for(var c=null,d=o.firstChild;d;){var u=d.nextSibling;if(this._isPhrasingContent(d))null!==c?c.appendChild(d):this._isWhitespace(d)||(c=n.createElement("p"),o.replaceChild(c,d),c.appendChild(d));else if(null!==c){for(;c.lastChild&&this._isWhitespace(c.lastChild);)c.lastChild.remove();c=null;}d=u;}if(this._hasSingleTagInsideElement(o,"P")&&this._getLinkDensity(o)<.25){var h=o.children[0];o.parentNode.replaceChild(h,o),o=h,s.push(o);}else this._hasChildBlockElement(o)||(o=this._setNodeTag(o,"P"),s.push(o));}o=this._getNextNode(o);}else o=this._removeAndGetNext(o);}else {for(var g=this._getNextNode(o,true),p=this._getNextNode(o),b=null;p&&p!=g;){var v=p.getAttribute("itemprop");if(v&&v.includes("name")){b=p;break}p=this._getNextNode(p);}this._articleByline=(b??o).textContent.trim(),o=this._removeAndGetNext(o);}else o=this._removeAndGetNext(o);else this.log("Removing hidden node - "+l),o=this._removeAndGetNext(o);}var E=[];this._forEachNode(s,(function(t){if(t.parentNode&&void 0!==t.parentNode.tagName){var n=this._getInnerText(t);if(!(n.length<25)){var r=this._getNodeAncestors(t,5);if(0!==r.length){var i=0;i+=1,i+=n.split(this.REGEXPS.commas).length,i+=Math.min(Math.floor(n.length/100),3),this._forEachNode(r,(function(t,n){if(t.tagName&&t.parentNode&&void 0!==t.parentNode.tagName){if(void 0===t.readability&&(this._initializeNode(t),E.push(t)),0===n)var r=1;else r=1===n?2:3*n;t.readability.contentScore+=i/r;}}));}}}}));for(var w=[],T=0,A=E.length;T<A;T+=1){var S=E[T],x=S.readability.contentScore*(1-this._getLinkDensity(S));S.readability.contentScore=x,this.log("Candidate:",S,"with score "+x);for(var C=0;C<this._nbTopCandidates;C++){var L=w[C];if(!L||x>L.readability.contentScore){w.splice(C,0,S),w.length>this._nbTopCandidates&&w.pop();break}}}var R,k=w[0]||null,P=false;if(null===k||"BODY"===k.tagName){for(k=n.createElement("DIV"),P=true;t.firstChild;)this.log("Moving child out:",t.firstChild),k.appendChild(t.firstChild);t.appendChild(k),this._initializeNode(k);}else if(k){for(var D=[],I=1;I<w.length;I++)w[I].readability.contentScore/k.readability.contentScore>=.75&&D.push(this._getNodeAncestors(w[I]));if(D.length>=3)for(R=k.parentNode;"BODY"!==R.tagName;){for(var O=0,B=0;B<D.length&&O<3;B++)O+=Number(D[B].includes(R));if(O>=3){k=R;break}R=R.parentNode;}k.readability||this._initializeNode(k),R=k.parentNode;for(var M=k.readability.contentScore,V=M/3;"BODY"!==R.tagName;)if(R.readability){var $=R.readability.contentScore;if($<V)break;if($>M){k=R;break}M=R.readability.contentScore,R=R.parentNode;}else R=R.parentNode;for(R=k.parentNode;"BODY"!=R.tagName&&1==R.children.length;)R=(k=R).parentNode;k.readability||this._initializeNode(k);}var G=n.createElement("DIV");r&&(G.id="readability-content");for(var j=Math.max(10,.2*k.readability.contentScore),F=(R=k.parentNode).children,z=0,W=F.length;z<W;z++){var X=F[z],J=false;if(this.log("Looking at sibling node:",X,X.readability?"with score "+X.readability.contentScore:""),this.log("Sibling has score",X.readability?X.readability.contentScore:"Unknown"),X===k)J=true;else {var q=0;if(X.className===k.className&&""!==k.className&&(q+=.2*k.readability.contentScore),X.readability&&X.readability.contentScore+q>=j)J=true;else if("P"===X.nodeName){var K=this._getLinkDensity(X),Y=this._getInnerText(X),Q=Y.length;(Q>80&&K<.25||Q<80&&Q>0&&0===K&&-1!==Y.search(/\.( |$)/))&&(J=true);}}J&&(this.log("Appending node:",X),this.ALTER_TO_DIV_EXCEPTIONS.includes(X.nodeName)||(this.log("Altering sibling:",X,"to div."),X=this._setNodeTag(X,"DIV")),G.appendChild(X),F=R.children,z-=1,W-=1);}if(this._debug&&this.log("Article content pre-prep: "+G.innerHTML),this._prepArticle(G),this._debug&&this.log("Article content post-prep: "+G.innerHTML),P)k.id="readability-page-1",k.className="page";else {var Z=n.createElement("DIV");for(Z.id="readability-page-1",Z.className="page";G.firstChild;)Z.appendChild(G.firstChild);G.appendChild(Z);}this._debug&&this.log("Article content after paging: "+G.innerHTML);var ee=true,te=this._getInnerText(G,true).length;if(te<this._charThreshold)if(ee=false,t.innerHTML=i,this._attempts.push({articleContent:G,textLength:te}),this._flagIsActive(this.FLAG_STRIP_UNLIKELYS))this._removeFlag(this.FLAG_STRIP_UNLIKELYS);else if(this._flagIsActive(this.FLAG_WEIGHT_CLASSES))this._removeFlag(this.FLAG_WEIGHT_CLASSES);else if(this._flagIsActive(this.FLAG_CLEAN_CONDITIONALLY))this._removeFlag(this.FLAG_CLEAN_CONDITIONALLY);else {if(this._attempts.sort((function(t,n){return n.textLength-t.textLength})),!this._attempts[0].textLength)return null;G=this._attempts[0].articleContent,ee=true;}if(ee){var ne=[R,k].concat(this._getNodeAncestors(R));return this._someNode(ne,(function(t){if(!t.tagName)return  false;var n=t.getAttribute("dir");return !!n&&(this._articleDir=n,true)})),G}}},_unescapeHtmlEntities(t){if(!t)return t;var n=this.HTML_ESCAPE_MAP;return t.replace(/&(quot|amp|apos|lt|gt);/g,(function(t,r){return n[r]})).replace(/&#(?:x([0-9a-f]+)|([0-9]+));/gi,(function(t,n,r){var i=parseInt(n||r,n?16:10);return (0==i||i>1114111||i>=55296&&i<=57343)&&(i=65533),String.fromCodePoint(i)}))},_getJSONLD(t){var n,r=this._getAllNodesWithTag(t,["script"]);return this._forEachNode(r,(function(t){if(!n&&"application/ld+json"===t.getAttribute("type"))try{var r=t.textContent.replace(/^\s*<!\[CDATA\[|\]\]>\s*$/g,""),i=JSON.parse(r);if(Array.isArray(i)&&!(i=i.find((t=>t["@type"]&&t["@type"].match(this.REGEXPS.jsonLdArticleTypes)))))return;var a=/^https?\:\/\/schema\.org\/?$/;if(!("string"==typeof i["@context"]&&i["@context"].match(a)||"object"==typeof i["@context"]&&"string"==typeof i["@context"]["@vocab"]&&i["@context"]["@vocab"].match(a)))return;if(!i["@type"]&&Array.isArray(i["@graph"])&&(i=i["@graph"].find((t=>(t["@type"]||"").match(this.REGEXPS.jsonLdArticleTypes)))),!i||!i["@type"]||!i["@type"].match(this.REGEXPS.jsonLdArticleTypes))return;if(n={},"string"==typeof i.name&&"string"==typeof i.headline&&i.name!==i.headline){var s=this._getArticleTitle(),o=this._textSimilarity(i.name,s)>.75,l=this._textSimilarity(i.headline,s)>.75;n.title=l&&!o?i.headline:i.name;}else "string"==typeof i.name?n.title=i.name.trim():"string"==typeof i.headline&&(n.title=i.headline.trim());i.author&&("string"==typeof i.author.name?n.byline=i.author.name.trim():Array.isArray(i.author)&&i.author[0]&&"string"==typeof i.author[0].name&&(n.byline=i.author.filter((function(t){return t&&"string"==typeof t.name})).map((function(t){return t.name.trim()})).join(", "))),"string"==typeof i.description&&(n.excerpt=i.description.trim()),i.publisher&&"string"==typeof i.publisher.name&&(n.siteName=i.publisher.name.trim()),"string"==typeof i.datePublished&&(n.datePublished=i.datePublished.trim());}catch(c){this.log(c.message);}})),n||{}},_getArticleMetadata(t){var n={},r={},i=this._doc.getElementsByTagName("meta"),a=/\s*(article|dc|dcterm|og|twitter)\s*:\s*(author|creator|description|published_time|title|site_name)\s*/gi,s=/^\s*(?:(dc|dcterm|og|twitter|parsely|weibo:(article|webpage))\s*[-\.:]\s*)?(author|creator|pub-date|description|title|site_name)\s*$/i;this._forEachNode(i,(function(t){var n=t.getAttribute("name"),i=t.getAttribute("property"),o=t.getAttribute("content");if(o){var l=null,c=null;i&&(l=i.match(a))&&(c=l[0].toLowerCase().replace(/\s/g,""),r[c]=o.trim()),!l&&n&&s.test(n)&&(c=n,o&&(c=c.toLowerCase().replace(/\s/g,"").replace(/\./g,":"),r[c]=o.trim()));}})),n.title=t.title||r["dc:title"]||r["dcterm:title"]||r["og:title"]||r["weibo:article:title"]||r["weibo:webpage:title"]||r.title||r["twitter:title"]||r["parsely-title"],n.title||(n.title=this._getArticleTitle());const o="string"!=typeof r["article:author"]||this._isUrl(r["article:author"])?void 0:r["article:author"];return n.byline=t.byline||r["dc:creator"]||r["dcterm:creator"]||r.author||r["parsely-author"]||o,n.excerpt=t.excerpt||r["dc:description"]||r["dcterm:description"]||r["og:description"]||r["weibo:article:description"]||r["weibo:webpage:description"]||r.description||r["twitter:description"],n.siteName=t.siteName||r["og:site_name"],n.publishedTime=t.datePublished||r["article:published_time"]||r["parsely-pub-date"]||null,n.title=this._unescapeHtmlEntities(n.title),n.byline=this._unescapeHtmlEntities(n.byline),n.excerpt=this._unescapeHtmlEntities(n.excerpt),n.siteName=this._unescapeHtmlEntities(n.siteName),n.publishedTime=this._unescapeHtmlEntities(n.publishedTime),n},_isSingleImage(t){for(;t;){if("IMG"===t.tagName)return  true;if(1!==t.children.length||""!==t.textContent.trim())return  false;t=t.children[0];}return  false},_unwrapNoscriptImages(t){var n=Array.from(t.getElementsByTagName("img"));this._forEachNode(n,(function(t){for(var n=0;n<t.attributes.length;n++){var r=t.attributes[n];switch(r.name){case "src":case "srcset":case "data-src":case "data-srcset":return}if(/\.(jpg|jpeg|png|webp)/i.test(r.value))return}t.remove();}));var r=Array.from(t.getElementsByTagName("noscript"));this._forEachNode(r,(function(n){if(this._isSingleImage(n)){var r=t.createElement("div");r.innerHTML=n.innerHTML;var i=n.previousElementSibling;if(i&&this._isSingleImage(i)){var a=i;"IMG"!==a.tagName&&(a=i.getElementsByTagName("img")[0]);for(var s=r.getElementsByTagName("img")[0],o=0;o<a.attributes.length;o++){var l=a.attributes[o];if(""!==l.value&&("src"===l.name||"srcset"===l.name||/\.(jpg|jpeg|png|webp)/i.test(l.value))){if(s.getAttribute(l.name)===l.value)continue;var c=l.name;s.hasAttribute(c)&&(c="data-old-"+c),s.setAttribute(c,l.value);}}n.parentNode.replaceChild(r.firstElementChild,i);}}}));},_removeScripts(t){this._removeNodes(this._getAllNodesWithTag(t,["script","noscript"]));},_hasSingleTagInsideElement(t,n){return 1==t.children.length&&t.children[0].tagName===n&&!this._someNode(t.childNodes,(function(t){return t.nodeType===this.TEXT_NODE&&this.REGEXPS.hasContent.test(t.textContent)}))},_isElementWithoutContent(t){return !(t.nodeType!==this.ELEMENT_NODE||t.textContent.trim().length||t.children.length&&t.children.length!=t.getElementsByTagName("br").length+t.getElementsByTagName("hr").length)},_hasChildBlockElement(t){return this._someNode(t.childNodes,(function(t){return this.DIV_TO_P_ELEMS.has(t.tagName)||this._hasChildBlockElement(t)}))},_isPhrasingContent(t){return t.nodeType===this.TEXT_NODE||this.PHRASING_ELEMS.includes(t.tagName)||("A"===t.tagName||"DEL"===t.tagName||"INS"===t.tagName)&&this._everyNode(t.childNodes,this._isPhrasingContent)},_isWhitespace(t){return t.nodeType===this.TEXT_NODE&&0===t.textContent.trim().length||t.nodeType===this.ELEMENT_NODE&&"BR"===t.tagName},_getInnerText(t,n){n=void 0===n||n;var r=t.textContent.trim();return n?r.replace(this.REGEXPS.normalize," "):r},_getCharCount(t,n){return n=n||",",this._getInnerText(t).split(n).length-1},_cleanStyles(t){if(t&&"svg"!==t.tagName.toLowerCase()){for(var n=0;n<this.PRESENTATIONAL_ATTRIBUTES.length;n++)t.removeAttribute(this.PRESENTATIONAL_ATTRIBUTES[n]);this.DEPRECATED_SIZE_ATTRIBUTE_ELEMS.includes(t.tagName)&&(t.removeAttribute("width"),t.removeAttribute("height"));for(var r=t.firstElementChild;null!==r;)this._cleanStyles(r),r=r.nextElementSibling;}},_getLinkDensity(t){var n=this._getInnerText(t).length;if(0===n)return 0;var r=0;return this._forEachNode(t.getElementsByTagName("a"),(function(t){var n=t.getAttribute("href"),i=n&&this.REGEXPS.hashUrl.test(n)?.3:1;r+=this._getInnerText(t).length*i;})),r/n},_getClassWeight(t){if(!this._flagIsActive(this.FLAG_WEIGHT_CLASSES))return 0;var n=0;return "string"==typeof t.className&&""!==t.className&&(this.REGEXPS.negative.test(t.className)&&(n-=25),this.REGEXPS.positive.test(t.className)&&(n+=25)),"string"==typeof t.id&&""!==t.id&&(this.REGEXPS.negative.test(t.id)&&(n-=25),this.REGEXPS.positive.test(t.id)&&(n+=25)),n},_clean(t,n){var r=["object","embed","iframe"].includes(n);this._removeNodes(this._getAllNodesWithTag(t,[n]),(function(t){if(r){for(var n=0;n<t.attributes.length;n++)if(this._allowedVideoRegex.test(t.attributes[n].value))return  false;if("object"===t.tagName&&this._allowedVideoRegex.test(t.innerHTML))return  false}return  true}));},_hasAncestorTag(t,n,r,i){r=r||3,n=n.toUpperCase();for(var a=0;t.parentNode;){if(r>0&&a>r)return  false;if(t.parentNode.tagName===n&&(!i||i(t.parentNode)))return  true;t=t.parentNode,a++;}return  false},_getRowAndColumnCount(t){for(var n=0,r=0,i=t.getElementsByTagName("tr"),a=0;a<i.length;a++){var s=i[a].getAttribute("rowspan")||0;s&&(s=parseInt(s,10)),n+=s||1;for(var o=0,l=i[a].getElementsByTagName("td"),c=0;c<l.length;c++){var d=l[c].getAttribute("colspan")||0;d&&(d=parseInt(d,10)),o+=d||1;}r=Math.max(r,o);}return {rows:n,columns:r}},_markDataTables(t){for(var n=t.getElementsByTagName("table"),r=0;r<n.length;r++){var i=n[r];if("presentation"!=i.getAttribute("role"))if("0"!=i.getAttribute("datatable"))if(i.getAttribute("summary"))i._readabilityDataTable=true;else {var a=i.getElementsByTagName("caption")[0];if(a&&a.childNodes.length)i._readabilityDataTable=true;else {if(["col","colgroup","tfoot","thead","th"].some((function(t){return !!i.getElementsByTagName(t)[0]})))this.log("Data table because found data-y descendant"),i._readabilityDataTable=true;else if(i.getElementsByTagName("table")[0])i._readabilityDataTable=false;else {var s=this._getRowAndColumnCount(i);1!=s.columns&&1!=s.rows?s.rows>=10||s.columns>4?i._readabilityDataTable=true:i._readabilityDataTable=s.rows*s.columns>10:i._readabilityDataTable=false;}}}else i._readabilityDataTable=false;else i._readabilityDataTable=false;}},_fixLazyImages(t){this._forEachNode(this._getAllNodesWithTag(t,["img","picture","figure"]),(function(t){if(t.src&&this.REGEXPS.b64DataUrl.test(t.src)){var n=this.REGEXPS.b64DataUrl.exec(t.src);if("image/svg+xml"===n[1])return;for(var r=false,i=0;i<t.attributes.length;i++){var a=t.attributes[i];if("src"!==a.name&&/\.(jpg|jpeg|png|webp)/i.test(a.value)){r=true;break}}if(r){var s=n[0].length;t.src.length-s<133&&t.removeAttribute("src");}}if(!(t.src||t.srcset&&"null"!=t.srcset)||t.className.toLowerCase().includes("lazy"))for(var o=0;o<t.attributes.length;o++)if("src"!==(a=t.attributes[o]).name&&"srcset"!==a.name&&"alt"!==a.name){var l=null;if(/\.(jpg|jpeg|png|webp)\s+\d/.test(a.value)?l="srcset":/^\s*\S+\.(jpg|jpeg|png|webp)\S*\s*$/.test(a.value)&&(l="src"),l)if("IMG"===t.tagName||"PICTURE"===t.tagName)t.setAttribute(l,a.value);else if("FIGURE"===t.tagName&&!this._getAllNodesWithTag(t,["img","picture"]).length){var c=this._doc.createElement("img");c.setAttribute(l,a.value),t.appendChild(c);}}}));},_getTextDensity(t,n){var r=this._getInnerText(t,true).length;if(0===r)return 0;var i=0,a=this._getAllNodesWithTag(t,n);return this._forEachNode(a,(t=>i+=this._getInnerText(t,true).length)),i/r},_cleanConditionally(t,n){this._flagIsActive(this.FLAG_CLEAN_CONDITIONALLY)&&this._removeNodes(this._getAllNodesWithTag(t,[n]),(function(t){var isDataTable=function(t){return t._readabilityDataTable},r="ul"===n||"ol"===n;if(!r){var i=0,a=this._getAllNodesWithTag(t,["ul","ol"]);this._forEachNode(a,(t=>i+=this._getInnerText(t).length)),r=i/this._getInnerText(t).length>.9;}if("table"===n&&isDataTable(t))return  false;if(this._hasAncestorTag(t,"table",-1,isDataTable))return  false;if(this._hasAncestorTag(t,"code"))return  false;if([...t.getElementsByTagName("table")].some((t=>t._readabilityDataTable)))return  false;var s=this._getClassWeight(t);this.log("Cleaning Conditionally",t);if(s+0<0)return  true;if(this._getCharCount(t,",")<10){for(var o=t.getElementsByTagName("p").length,l=t.getElementsByTagName("img").length,c=t.getElementsByTagName("li").length-100,d=t.getElementsByTagName("input").length,u=this._getTextDensity(t,["h1","h2","h3","h4","h5","h6"]),h=0,g=this._getAllNodesWithTag(t,["object","embed","iframe"]),p=0;p<g.length;p++){for(var b=0;b<g[p].attributes.length;b++)if(this._allowedVideoRegex.test(g[p].attributes[b].value))return  false;if("object"===g[p].tagName&&this._allowedVideoRegex.test(g[p].innerHTML))return  false;h++;}var v=this._getInnerText(t);if(this.REGEXPS.adWords.test(v)||this.REGEXPS.loadingWords.test(v))return  true;var E=v.length,w=this._getLinkDensity(t),T=["SPAN","LI","TD"].concat(Array.from(this.DIV_TO_P_ELEMS)),A=this._getTextDensity(t,T),S=this._hasAncestorTag(t,"figure");var x=(()=>{const t=[];return !S&&l>1&&o/l<.5&&t.push(`Bad p to img ratio (img=${l}, p=${o})`),!r&&c>o&&t.push(`Too many li's outside of a list. (li=${c} > p=${o})`),d>Math.floor(o/3)&&t.push(`Too many inputs per p. (input=${d}, p=${o})`),!r&&!S&&u<.9&&E<25&&(0===l||l>2)&&w>0&&t.push(`Suspiciously short. (headingDensity=${u}, img=${l}, linkDensity=${w})`),!r&&s<25&&w>.2+this._linkDensityModifier&&t.push(`Low weight and a little linky. (linkDensity=${w})`),s>=25&&w>.5+this._linkDensityModifier&&t.push(`High weight and mostly links. (linkDensity=${w})`),(1===h&&E<75||h>1)&&t.push(`Suspicious embed. (embedCount=${h}, contentLength=${E})`),0===l&&0===A&&t.push(`No useful content. (img=${l}, textDensity=${A})`),!!t.length&&(this.log("Checks failed",t),true)})();if(r&&x){for(var C=0;C<t.children.length;C++){if(t.children[C].children.length>1)return x}let n=t.getElementsByTagName("li").length;if(l==n)return  false}return x}return  false}));},_cleanMatchedNodes(t,n){for(var r=this._getNextNode(t,true),i=this._getNextNode(t);i&&i!=r;)i=n.call(this,i,i.className+" "+i.id)?this._removeAndGetNext(i):this._getNextNode(i);},_cleanHeaders(t){let n=this._getAllNodesWithTag(t,["h1","h2"]);this._removeNodes(n,(function(t){let n=this._getClassWeight(t)<0;return n&&this.log("Removing header with low class weight:",t),n}));},_headerDuplicatesTitle(t){if("H1"!=t.tagName&&"H2"!=t.tagName)return  false;var n=this._getInnerText(t,false);return this.log("Evaluating similarity of header:",n,this._articleTitle),this._textSimilarity(this._articleTitle,n)>.75},_flagIsActive(t){return (this._flags&t)>0},_removeFlag(t){this._flags=this._flags&~t;},_isProbablyVisible:t=>(!t.style||"none"!=t.style.display)&&(!t.style||"hidden"!=t.style.visibility)&&!t.hasAttribute("hidden")&&(!t.hasAttribute("aria-hidden")||"true"!=t.getAttribute("aria-hidden")||t.className&&t.className.includes&&t.className.includes("fallback-image")),parse(){if(this._maxElemsToParse>0){var t=this._doc.getElementsByTagName("*").length;if(t>this._maxElemsToParse)throw new Error("Aborting parsing document; "+t+" elements found")}this._unwrapNoscriptImages(this._doc);var n=this._disableJSONLD?{}:this._getJSONLD(this._doc);this._removeScripts(this._doc),this._prepDocument();var r=this._getArticleMetadata(n);this._metadata=r,this._articleTitle=r.title;var i=this._grabArticle();if(!i)return null;if(this.log("Grabbed: "+i.innerHTML),this._postProcessContent(i),!r.excerpt){var a=i.getElementsByTagName("p");a.length&&(r.excerpt=a[0].textContent.trim());}var s=i.textContent;return {title:this._articleTitle,byline:r.byline||this._articleByline,dir:this._articleDir,lang:this._articleLang,content:this._serializer(i),textContent:s,length:s.length,excerpt:r.excerpt,siteName:r.siteName||this._articleSiteName,publishedTime:r.publishedTime}}},t.exports=Readability;}(Ve)),Ve.exports}var $e,Ue,He,Ge={exports:{}};var je=function requireReadability(){if(He)return Ue;He=1;var t=requireReadability$1(),n=function requireReadabilityReaderable(){return $e||($e=1,function(){var t={unlikelyCandidates:/-ad-|ai2html|banner|breadcrumbs|combx|comment|community|cover-wrap|disqus|extra|footer|gdpr|header|legends|menu|related|remark|replies|rss|shoutbox|sidebar|skyscraper|social|sponsor|supplemental|ad-break|agegate|pagination|pager|popup|yom-remote/i,okMaybeItsACandidate:/and|article|body|column|content|main|shadow/i};function isNodeVisible(t){return (!t.style||"none"!=t.style.display)&&!t.hasAttribute("hidden")&&(!t.hasAttribute("aria-hidden")||"true"!=t.getAttribute("aria-hidden")||t.className&&t.className.includes&&t.className.includes("fallback-image"))}Ge.exports=function isProbablyReaderable(n,r={}){"function"==typeof r&&(r={visibilityChecker:r});var i={minScore:20,minContentLength:140,visibilityChecker:isNodeVisible};r=Object.assign(i,r);var a=n.querySelectorAll("p, pre, article"),s=n.querySelectorAll("div > br");if(s.length){var o=new Set(a);[].forEach.call(s,(function(t){o.add(t.parentNode);})),a=Array.from(o);}var l=0;return [].some.call(a,(function(n){if(!r.visibilityChecker(n))return  false;var i=n.className+" "+n.id;if(t.unlikelyCandidates.test(i)&&!t.okMaybeItsACandidate.test(i))return  false;if(n.matches("li p"))return  false;var a=n.textContent.trim().length;return !(a<r.minContentLength)&&(l+=Math.sqrt(a-r.minContentLength))>r.minScore}))};}()),Ge.exports}();return Ue={Readability:t,isProbablyReaderable:n}}();const f=t=>null==t||""===t,_=(t,n)=>Object.keys(t).reduce(((t,r)=>(n(t[r])&&delete t[r],t)),t),Fe=["<b>","</b>"],y=t=>((t,n)=>({...n,..._(t,f)}))(t,{sep:Fe,fixationPoint:1,ignoreHtmlTag:true,ignoreHtmlEntity:true}),ze=[[0,4,12,17,24,29,35,42,48],[1,2,7,10,13,14,19,22,25,28,31,34,37,40,43,46,49],[1,2,5,7,9,11,13,15,17,19,21,23,25,27,29,31,33,35,37,39,41,43,45,47,49],[0,2,4,5,6,8,9,11,14,15,17,18,20,0,21,23,24,26,27,29,30,32,33,35,36,38,39,41,42,44,45,47,48],[0,2,3,5,6,7,8,10,11,12,14,15,17,19,20,21,23,24,25,26,28,29,30,32,33,34,35,37,38,39,41,42,43,44,46,47,48]],H=(t,n)=>{const{length:r}=t,i=ze[n-1]??ze[0],a=i.findIndex((t=>r<=t));let s=r-a;return  -1===a&&(s=r-i.length),Math.max(s,0)},N=(t,n)=>"string"==typeof n?`${n}${t}${n}`:`${n[0]}${t}${n[1]}`,m=t=>Array.from(t).map((t=>{const n=t.index,[r]=t,{length:i}=r;return [n,n+i-1]})),We=/(<!--[\s\S]*?-->)|(<[^>]*>)/g,Xe=/(&[\w#]+;)/g,Je=/(\p{L}|\p{Nd})*\p{L}(\p{L}|\p{Nd})*/gu,U=(t,n={})=>{if(null==t||!t.length)return "";const{fixationPoint:r,sep:i,ignoreHtmlTag:a,ignoreHtmlEntity:s}=y(n),o=Array.from(t.matchAll(Je));let l,c,d="",u=0;a&&(l=(t=>{const n=t.matchAll(We),r=m(n).reverse();return t=>{const n=t.index,i=r.find((([t])=>n>t));if(!i)return  false;const[,a]=i;return n<a}})(t)),s&&(c=(t=>{const n=t.matchAll(Xe),r=m(n).reverse();return t=>{const n=t.index,i=r.find((([t])=>n>t));if(!i)return  false;const[,a]=i;return n<a}})(t));for(const h of o){if((null==l?void 0:l(h))||(null==c?void 0:c(h)))continue;const[n]=h,a=h.index,s=a+H(n,r);d+=t.slice(u,a),a!==s&&(d+=N(t.slice(a,s),i)),u=s;}return d+t.slice(u)},{div:qe,button:Ke,span:Ye}=g.tags,render=()=>{const t=findPrevNextChapterLinks(),n=qe({class:"config-chapter-link",style:"display: none; justify-content: center; align-items: center; margin: 5px 0; gap: 10px;"});return t.previous||t.next?(n.appendChild(chapterButton("<",t.previous)),n.appendChild(configButton()),n.appendChild(chapterButton(">",t.next))):n.appendChild(configButton()),n},visbile=()=>{Array.from(document.querySelectorAll("*")).map((t=>t.shadowRoot)).filter((t=>null!==t)).forEach((t=>{t?.querySelectorAll(".config-chapter-link").forEach((t=>{t.style.display="flex";}));}));},configButton=()=>{const t=Ye({class:"icon",style:'background-image: url(\'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>\'); width: 20px; height: 20px; display: block; background-size: contain;'});return Ke({onclick:()=>replaceAppState({openReaderConfig:true}),style:"height: 30px; min-width: 30px; display: flex; align-items: center; justify-content: center;"},t)},chapterButton=(t,n)=>Ke({disable:!n,onclick:()=>n&&(window.location.href=n),style:"height: 30px; min-width: 30px; display: flex; align-items: center; justify-content: center;"},t),{div:Qe}=g.tags;e("reader-view",(({mount:t})=>{const n=Qe({class:"content-container"}),r=g.state(false);return t((()=>((async()=>{const t=await(async t=>{try{return await db_get(`translated:${t}`)}catch(n){return console.error("Failed to get from history:",n),null}})(window.location.href);if(g.derive((()=>{r.val=ge.readerView.bionicReading,t&&(n.innerHTML=true===r.val?U(t):t,visbile(),console.log("////"));})),!t){n.innerText="[Xin đợi...]";const t=document.cloneNode(true),i=new je.Readability(t).parse();await translateFunc(i?.content,(t=>{n.innerHTML=true===r.val?U(t):t;})),visbile();}})(),()=>{g.derive((async()=>{ true===pe.isTranslating&&(pe.isTranslating=false,window.location.reload());}));}))),[render,n,render]}),false);const{div:Ze,select:et,option:tt,textarea:nt,label:rt,button:it}=g.tags,at=g.state("");function showSavedFeedback(){at.val="Saved",setTimeout((()=>{at.val="";}),2e3);}function PromptSelector({lbl:t,prompts:n,onSelect:r,onContentChange:i}){const a=n.find((t=>t.selected))||n[0],s=g.state(a?.content||"");return Ze({class:"pure-g",style:"padding: 0 0.5em; margin-bottom: 0.5em;"},Ze({class:"pure-u-1"},rt({class:""},t),Ze({class:"pure-form pure-form-stacked"},Ze({class:"pure-g",style:"padding-right: 1em"},Ze({class:"pure-u-20-24"},et({class:"pure-input-1",value:a?.name,onchange:t=>{const i=t.target.value;r(i);const a=n.find((t=>t.name===i));s.val=a?.content||"",showSavedFeedback();}},...n.map((t=>tt({value:t.name},t.name))))),Ze({class:"pure-u-4-24"},it({class:"pure-button",style:"margin-left: 0.5em; width: 40px; height: 30.5px; margin-top: 4px; padding: 0; line-height: 2.3em;"},"+"))))),Ze({class:"pure-u-1",style:"padding-right: 1em"},nt({class:"pure-input-1",style:"height: 150px; margin-top: 1em; resize: vertical; display: block; box-sizing: border-box; width: 100%;",value:s,onblur:t=>{const n=t.target.value;s.val=n,a&&i(a.name,n),showSavedFeedback();}})))}const{div:st,select:ot,option:lt,textarea:ct,label:dt,style:ut}=g.tags;function AiProviderTab(){const t=g.state(""),showSavedMessage=()=>{t.val="Saved",setTimeout((()=>t.val=""),2e3);};return st(st({class:"pure-g",style:"padding: 0 0.5em; "},st({class:"pure-u-1"},st({class:"pure-form pure-form-stacked"},st({class:"pure-control-group"},dt({class:"form-label"},"Provider"),ot({class:"pure-input-1",onchange:t=>{const n=t.target.value;ge.providers.forEach((t=>{t.selected=t.name===n;})),showSavedMessage();}},...ge.providers.map((t=>lt({selected:t.selected,value:t.name},t.name))))),st({class:"pure-control-group"},dt({class:"form-label"},"Model"),ot({class:"pure-input-1",onchange:t=>{const n=ge.providers.find((t=>t.selected));if(n){const r=t.target.value;n.models.forEach((t=>{t.selected=t.name===r;})),showSavedMessage();}}},(()=>{const t=ge.providers.find((t=>t.selected));return t?t.models.map((t=>lt({selected:t.selected,value:t.name},t.name))):[lt({disabled:true},"Select a provider first")]})())),st({class:"pure-control-group"},dt({class:"form-label"},"API Key"),ct({rows:4,class:"pure-input-1",placeholder:"Enter your API key",value:()=>ge.providers?.find((t=>t.selected))?.apiKey||"",onblur:t=>{const n=ge.providers.find((t=>t.selected));n&&(n.apiKey=t.target.value,showSavedMessage());}})),st({class:"pure-control-group"},(()=>{const t=ge.providers?.find((t=>t.selected))?.note;return t?st({innerHTML:t}):null})),dt({class:"saved-message"},(()=>t.val))))),ut("\n            .ai-provider-container {\n                max-width: 600px;\n                margin: 0 auto;\n            }\n            .form-label {\n                display: block;\n                margin-bottom: 0.5rem;\n                font-weight: 500;\n                color: #333;\n            }\n            .saved-message {\n                color: #00aa00;\n                margin: 0.5rem 0;\n                font-size: 0.9rem;\n                font-weight: bold;\n                text-align: center;\n                display: block;\n            }\n            textarea.pure-input-1 {\n                resize: none;\n                min-height: 100px;\n            }\n            \n            @media screen and (max-width: 48em) {\n\n            \n            }\n        "))}const{div:ht,label:gt,button:pt}=g.tags;function VersionTab(){const t=g.state("");return [ht({class:"pure-form pure-form-stacked"},[ht({class:"pure-g",style:"padding: 0px 0.5em;"},[ht({class:"pure-u-1 pure-u-md-1-2 pure-u-lg-1-3"},[gt({class:"pure-u-1"},`Current version: ${ge.version}`),ht({innerHTML:t,class:"pure-u-1",style:"margin-bottom:20px;border: 1px solid #ccc; min-height: 150px; background: #fff;"}),pt({onclick:async()=>{t.val=await async function displayVersion(t=false){const n=await getRelease(t);return `Latest version: ${n.version}<br/><b>Link download: </b><a href="${n.fileUrl}" target="blank">dichtruyen.ai.vn.user.js</a><br/>${n.description}`}(true);},class:"pure-button pure-button-primary pure-u-1",style:"margin-bottom: 10px"},"Check Update"),pt({onclick:async()=>await mergeSystemPrompt(ge),class:"pure-button button-success pure-u-1",style:"margin-bottom: 10px"},"Update System Prompt"),pt({onclick:async()=>await mergeProviders(ge),class:"pure-button button-success pure-u-1",style:"margin-bottom: 10px"},"Update AI Providers")])])])]}const{div:mt,style:ft}=g.tags;e("settings-view",(()=>[ft("\n            .tbbt.active{\n                background-color:rgba(58, 119, 224, 0.88) !important;\n            }\n        "),mt({id:"settings-container"},Tabs({style:"max-width: 500px;",tabButtonBorderStyle:"none",tabButtonClass:"tbbt",tabButtonRowColor:"none",tabButtonRowStyleOverrides:{"padding-left":"12px"}},{Prompt:[Ze({class:"pure-g"},Ze({class:"pure-u-1"},PromptSelector({lbl:"System Prompts",prompts:ge.prompt.systemPrompts.map((t=>({name:t.name,content:t.content||"",selected:t.selected}))),onSelect:t=>{ge.prompt.systemPrompts.forEach((n=>n.selected=n.name===t));},onContentChange:(t,n)=>{const r=ge.prompt.systemPrompts.find((n=>n.name===t));r&&(r.content=n);}}),PromptSelector({lbl:"User Prompts",prompts:ge.prompt.userPrompts.map((t=>({name:t.name,content:t.content||"",selected:t.selected}))),onSelect:t=>{ge.prompt.userPrompts.forEach((n=>n.selected=n.name===t));},onContentChange:(t,n)=>{const r=ge.prompt.userPrompts.find((n=>n.name===t));r&&(r.content=n);}}))),rt({id:"lblRs1",class:"pure-form-message-inline",style:"color: green; text-align: center; display: block; width: 100%"},at)],AI:AiProviderTab,Update:VersionTab()}))]),false);const{div:bt}=g.tags,CurrentView=()=>{const t=bt();return g.derive((()=>{if("empty"!==pe.currentView){if(t.id="view",t.childElementCount>0)for(const r of t.childNodes)r.remove();const n=document.createElement(`${pe.currentView}-view`);t.appendChild(n);}else if(t.id="",t.childElementCount>0)for(const n of t.childNodes)n.remove();})),t},{style:yt}=g.tags;await( async function initStore(){const t=await de.getValue("dichtruyen-ai"),n=await getRelease(true);if(t){let i=JSON.parse(t);const a=0==i.prompt.systemPrompts.length||0===i.providers.length;if(i.version!==n.version||a)try{i.version=n.version,i=await mergeSystemPrompt(i),i=await mergeProviders(i),he=i,console.log(he);}catch(r){console.error("Failed to fetch remote prompt:",r);}else he=i;}else {const t=await getSystemPrompt(),n=ue;n.prompt.systemPrompts.push({id:"default-0",name:"Default",content:t,selected:true});const r=await getAiProviders();n.providers=r?.providers,he=n,console.log(he);}replace(ge,he),g.derive((async()=>{console.log("Saved setting",(new Date).toUTCString()),await de.setValue("dichtruyen-ai",JSON.stringify(compact(ge)));}));}()),e("dichtruyen-ai",(()=>{const t=g.derive((()=>{const t="black"===ge.readerView.backgroundColor?"white":"black";return `\n    reader-view {\n      background-color: ${ge.readerView.backgroundColor} !important;\n    }\n    .content-container {\n      font-family: ${ge.readerView.fontFamily}, -apple-system, sans-serif;\n      line-height: ${ge.readerView.lineHeight};\n      font-size: ${ge.readerView.fontSize}px;\n      color: ${t};\n      margin: 5px auto;\n      padding: 10px;\n      box-sizing: border-box;\n      width: 100%;\n      max-width: 800px;\n      white-space: pre-wrap;\n    }\n    .article-title {\n      font-size: 1.5em;\n      font-weight: bold;\n      margin-bottom: 1em;\n      text-align: center;\n    }\n  `}));return [yt("\n          :host {\n            display: block;\n            height: 100%;\n            width: 100%;\n            pointer-events: all;\n          }\n        #bottom-bar {\n          position: fixed;\n          bottom: 0;\n          left: 0;\n          right: 0;\n          background-color: white;\n          box-shadow: 0 -2px 5px rgba(0,0,0,0.1);\n          padding: 10px;\n          display: flex;\n          justify-content: center;\n          gap: 20px;\n          width: 100%;\n          height: auto;\n          min-height: 60px;\n          box-sizing: border-box;\n          -webkit-overflow-scrolling: touch;\n          pointer-events: auto;\n          isolation: isolate;\n          z-index: 9999;\n        }\n        .icon-button {\n          background: none;\n          border: none;\n          cursor: pointer;\n          padding: 8px;\n          border-radius: 50%;\n          background-color: white;\n          box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n          touch-action: manipulation;\n          width: 40px;\n          height: 40px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          position: relative;\n          z-index: 1;\n        }\n        .icon {\n          display: inline-block;\n          width: 24px;\n          height: 24px;\n          background-size: contain;\n          background-repeat: no-repeat;\n          vertical-align: middle;\n        }\n        #mdlReaderContainer p{\n          margin: 5px 0px;\n        }\n      "),yt("\n      #view {\n          width: 100%;\n          height: 100%;\n          background-color: white;\n        }\n        history-view, settings-view, reader-view {\n          display: block;\n          width: 100%;\n\n          overflow-y: auto;\n          -webkit-overflow-scrolling: touch;\n          z-index: 9999;\n          position: fixed;\n          top: 0;\n          left: 0;\n          right: 0;\n          bottom: 60px;\n          overflow-y: auto;\n          -webkit-overflow-scrolling: touch;\n          background-color: white;\n        }\n      "),yt(t),Await({value:fetchResource("https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css"),container:yt,Loading:()=>""},(t=>t)),yt("\n    .button-success,\n        .button-error,\n        .button-warning,\n        .button-secondary {\n            color: white;\n            border-radius: 4px;\n            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);\n        }\n\n        .button-success {\n            background: rgb(28, 184, 65);\n            /* this is a green */\n        }\n\n        .button-error {\n            background: rgb(202, 60, 60);\n            /* this is a maroon */\n        }\n\n        .button-warning {\n            background: rgb(223, 117, 20);\n            /* this is an orange */\n        }\n\n        .button-secondary {\n            background: rgb(66, 184, 221);\n            /* this is a light blue */\n        }  \n      "),CurrentView(),ModalReaderConfig(),(g.derive((()=>{"reader"===pe.currentView&&(true===pe.isTranslating?changeIcon(Ne):changeIcon(ve));})),be({id:"bottom-bar"},createIconButton(ye,(()=>changeView("history"))),createIconButton(ve,(()=>changeView("reader")),"transButton"),createIconButton(_e,(()=>changeView("settings")))))]}));const vt=document.createElement("dichtruyen-ai");window.parent.document.body.appendChild(vt);

})();